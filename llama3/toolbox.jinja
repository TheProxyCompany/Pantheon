{# ------------------------------------------------------------------------ #}
{# Toolbox: renders tool definitions as a self-contained context block.     #}
{# ------------------------------------------------------------------------ #}
{# ------------------------------------------------------------------------ #}
{# Configuration                                                            #}
{# ------------------------------------------------------------------------ #}
{%- if capabilities is defined and capabilities.tool_calling is defined -%}
    {%- set tc_tokens = capabilities.tool_calling.formats[0].tokens -%}
{%- else -%}
    {%- set tc_tokens = none -%}
{%- endif -%}
{# ------------------------------------------------------------------------ #}
{# Macro: render_role_header                                                #}
{# ------------------------------------------------------------------------ #}
{%- macro render_role_header(role_key) -%}
    {%- set role = roles.get(role_key) -%}
    {%- if role is not none -%}
        {{- role.role_start_tag + role.role_name + role.role_end_tag -}}
    {%- endif -%}
{%- endmacro -%}
{# ------------------------------------------------------------------------ #}
{# Macro: render_tool                                                       #}
{# Renders a single tool: name, description, parameter schema.             #}
{# ------------------------------------------------------------------------ #}
{%- macro render_tool(tool) -%}
    {{ "\n--- " + tool.name + " ---\n" }}
    {{- "Name: " + tool.name + "\n" -}}
    {%- if tool.description is defined -%}
        {{- "Description: " + tool.description + "\n" -}}
    {%- endif -%}
    {{- "Parameters:\n" + tool.properties.arguments.properties | tojson(indent=2, ensure_ascii=False) | trim + "\n" }}
    {{- "Required: " + tool.properties.arguments.required | join(", ") -}}
{%- endmacro -%}
{# ------------------------------------------------------------------------ #}
{# Main template                                                            #}
{# ------------------------------------------------------------------------ #}
{%- if tools and tc_tokens -%}
    {{- begin_of_text -}}
    {{- render_role_header("system") -}}
    {{- "Environment: ipython\n\n" }}

    {{- "Tools:" -}}
    {%- for t in tools %}
        {{- render_tool(t) -}}
    {%- endfor %}
    {{ "\n--- End of tools ---\n" }}

    {{- "To use a tool, invoke it by wrapping the appropriate schema in the delimiters " + tc_tokens.start.replace('\n', '\\n') + " and " + tc_tokens.end.replace('\n', '\\n') + ".\n" -}}
    {{- end_of_sequence -}}
{%- endif -%}
